<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Academy | Reservation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .calendar-cell { min-height: 100px; transition: all 0.2s; }
        .calendar-cell:hover:not(.bg-red-50) { background-color: #f0f4ff; border-color: #6366f1; }
        .time-badge { font-size: 0.7rem; font-weight: 800; color: #4338ca; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen">

    <header class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black text-indigo-900 flex items-center">
                <i class="fa-solid fa-graduation-cap mr-2"></i> 学習塾サージュ
            </h1>
            <div id="loading-indicator" class="text-indigo-600 text-sm font-bold flex items-center">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> 同期中...
            </div>
        </div>
    </header>

    <div id="admin-toolbar" class="hidden bg-slate-800 text-white p-3 sticky top-[65px] z-40 shadow-md">
        <div class="max-w-5xl mx-auto flex justify-between items-center text-xs md:text-sm">
            <div class="flex items-center"><span class="bg-red-500 px-2 py-1 rounded font-bold mr-2">管理者</span>日付をクリックで変更</div>
            <div class="flex space-x-2">
                <button onclick="openGlobalSettings()" class="bg-slate-600 px-3 py-1.5 rounded">一括設定</button>
                <button onclick="saveChangesToGAS(true)" class="bg-emerald-600 px-3 py-1.5 rounded font-bold">全て保存</button>
                <button onclick="location.reload()" class="bg-gray-600 px-3 py-1.5 rounded">終了</button>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-6 animate-fade-in">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
            <div class="flex items-center justify-between p-6 bg-indigo-50 border-b border-indigo-100">
                <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-left"></i></button>
                <h2 id="current-month-display" class="text-xl md:text-2xl font-black text-indigo-900"></h2>
                <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 bg-white">
                <div class="py-3 text-center text-xs font-black text-red-500 bg-indigo-50/50 border-b border-r">日</div>
                <div class="py-3 text-center text-xs font-black text-slate-500 bg-indigo-50/50 border-b border-r">月</div>
                <div class="py-3 text-center text-xs font-black text-slate-500 bg-indigo-50/50 border-b border-r">火</div>
                <div class="py-3 text-center text-xs font-black text-slate-500 bg-indigo-50/50 border-b border-r">水</div>
                <div class="py-3 text-center text-xs font-black text-slate-500 bg-indigo-50/50 border-b border-r">木</div>
                <div class="py-3 text-center text-xs font-black text-slate-500 bg-indigo-50/50 border-b border-r">金</div>
                <div class="py-3 text-center text-xs font-black text-blue-500 bg-indigo-50/50 border-b">土</div>
            </div>
        </div>
    </main>

    <div id="reservation-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-indigo-600 p-6 text-white flex justify-between items-start">
                <div><h3 class="font-black text-2xl">授業予約</h3><p id="modal-date-label" class="mt-1 font-bold opacity-80"></p></div>
                <button onclick="closeModal('reservation-modal')" class="text-white/50 hover:text-white"><i class="fa-solid fa-circle-xmark text-3xl"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div><label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block">生徒氏名</label><input type="text" id="input-name" placeholder="お名前を入力" class="w-full border-2 border-slate-100 p-4 rounded-2xl focus:border-indigo-500 outline-none transition font-bold"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block">開始時間</label><select id="select-start-time" onchange="updateEndTimes()" class="w-full border-2 border-slate-100 p-4 rounded-2xl bg-white font-bold"></select></div>
                    <div><label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block">終了時間</label><select id="select-end-time" class="w-full border-2 border-slate-100 p-4 rounded-2xl bg-white font-bold"></select></div>
                </div>
                <button onclick="submitReservation()" id="submit-btn" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-indigo-700 transition-all transform hover:scale-[1.02]">予約を確定する</button>
            </div>
        </div>
    </div>

    <div id="global-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-lg overflow-hidden p-8 space-y-6 shadow-2xl">
            <h3 class="text-2xl font-black text-slate-800">一括設定</h3>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-sm font-bold text-slate-500">標準 開講 (時)</label><input type="number" id="global-open-hour" class="w-full border p-4 rounded-xl font-bold"></div>
                <div><label class="text-sm font-bold text-slate-500">標準 閉講 (時)</label><input type="number" id="global-close-hour" class="w-full border p-4 rounded-xl font-bold"></div>
            </div>
            <div>
                <label class="text-sm font-bold text-slate-500 block mb-3">定休日</label>
                <div class="flex flex-wrap gap-4 font-bold">
                    <label class="flex items-center"><input type="checkbox" name="dow" value="1" class="mr-2">月</label>
                    <label class="flex items-center"><input type="checkbox" name="dow" value="2" class="mr-2">火</label>
                    <label class="flex items-center"><input type="checkbox" name="dow" value="3" class="mr-2">水</label>
                    <label class="flex items-center"><input type="checkbox" name="dow" value="4" class="mr-2">木</label>
                    <label class="flex items-center"><input type="checkbox" name="dow" value="5" class="mr-2">金</label>
                    <label class="flex items-center text-blue-600"><input type="checkbox" name="dow" value="6" class="mr-2">土</label>
                    <label class="flex items-center text-red-600"><input type="checkbox" name="dow" value="0" class="mr-2">日</label>
                </div>
            </div>
            <button onclick="saveGlobalSettings()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl">設定を保存して適用</button>
        </div>
    </div>

    <div id="date-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden p-8 space-y-4">
            <h3 id="admin-date-title" class="text-xl font-black">個別設定</h3>
            <div class="space-y-3 font-bold">
                <label class="block p-4 border rounded-2xl cursor-pointer"><input type="radio" name="day-status" value="default" checked onchange="toggleTimeInputs(false)"> 通常通り</label>
                <label class="block p-4 border rounded-2xl cursor-pointer bg-red-50 border-red-100 text-red-600"><input type="radio" name="day-status" value="closed" onchange="toggleTimeInputs(false)"> 休講にする</label>
                <label class="block p-4 border rounded-2xl cursor-pointer bg-emerald-50 border-emerald-100 text-emerald-600"><input type="radio" name="day-status" value="open" onchange="toggleTimeInputs(true)"> 開講(時間指定)</label>
            </div>
            <div id="admin-time-inputs" class="hidden flex items-center gap-2"><input type="number" id="temp-open" class="border w-full p-3 rounded-xl"><span>~</span><input type="number" id="temp-close" class="border w-full p-3 rounded-xl"></div>
            <button onclick="applyDateSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">決定</button>
        </div>
    </div>

    <footer class="bg-slate-100 py-10 text-center">
        <button onclick="adminLogin()" class="text-xs text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-lock mr-1"></i>管理者ログイン</button>
    </footer>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby74NtaPTr1XfqV3vQ_NhbyrO_uey4yxdOzT4rVoIO7KZdRM1x5Qd_MZxyyRQRNS93m/exec"; 
        let APP_CONFIG = { openHour: 10, closeHour: 22, closedDaysOfWeek: [0], exceptions: {}, reservations: [] };
        let currentDate = new Date(), selectedDateStr = "", isAdminMode = false, isConfigLoaded = false;

        window.onload = loadAllData;

        async function loadAllData() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                const cfg = data.config || {};
                APP_CONFIG.openHour = Number(cfg.openHour) || 10;
                APP_CONFIG.closeHour = Number(cfg.closeHour) || 22;
                if(cfg.closedDays) APP_CONFIG.closedDaysOfWeek = String(cfg.closedDays).split(',').map(Number);
                if(cfg.exceptions) APP_CONFIG.exceptions = JSON.parse(cfg.exceptions);
                APP_CONFIG.reservations = data.reservations || [];
                isConfigLoaded = true;
                renderCalendar();
            } catch (e) {
                console.error(e);
                alert("データの取得に失敗しました。ページを更新してください。");
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calendar-grid');
            const dayHeaders = Array.from(grid.querySelectorAll('.bg-indigo-50\\/50'));
            grid.innerHTML = "";
            dayHeaders.forEach(h => grid.appendChild(h));

            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50/50 border-b border-r border-slate-100"></div>`;
            
            for(let d=1; d<=days; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dow = new Date(y, m, d).getDay();
                let status = "default", oh = APP_CONFIG.openHour, ch = APP_CONFIG.closeHour;
                
                if(APP_CONFIG.exceptions[dStr]) {
                    status = APP_CONFIG.exceptions[dStr].status;
                    if(status === 'open') { oh = APP_CONFIG.exceptions[dStr].open; ch = APP_CONFIG.exceptions[dStr].close; }
                } else { status = APP_CONFIG.closedDaysOfWeek.includes(dow) ? "closed" : "open"; }
                
                const closed = (status === "closed"), today = new Date().toDateString() === new Date(y, m, d).toDateString();
                const cell = document.createElement('div');
                cell.className = `calendar-cell border-b border-r border-slate-100 p-2 cursor-pointer flex flex-col items-center justify-between ${closed ? 'bg-red-50/50' : 'bg-white'}`;
                
                const dateCircle = today ? 'bg-indigo-600 text-white rounded-full' : (dow===0?'text-red-500':dow===6?'text-blue-500':'text-slate-600');
                
                cell.innerHTML = `
                    <span class="text-sm font-black w-7 h-7 flex items-center justify-center ${dateCircle}">${d}</span>
                    <div class="flex flex-col items-center mb-1">
                        ${closed ? '<span class="text-[9px] font-black text-red-400 bg-red-100 px-2 py-0.5 rounded">休校</span>' : `<span class="time-badge">${oh}:00-${ch}:00</span><span class="text-[8px] font-black text-emerald-500 mt-0.5">予約可</span>`}
                    </div>`;
                cell.onclick = () => isAdminMode ? openDateSettingModal(dStr, oh, ch) : (!closed && openReservationModal(dStr, oh, ch));
                grid.appendChild(cell);
            }
        }

        // --- 以下ロジック (リロード抑制などの修正済み) ---
        function openReservationModal(dStr, oh, ch) {
            selectedDateStr = dStr;
            document.getElementById('modal-date-label').innerText = `${dStr} （開講: ${oh}:00 - ${ch}:00）`;
            const s = document.getElementById('select-start-time'); s.innerHTML = "";
            const booked = APP_CONFIG.reservations.filter(r => r.date === dStr).map(r => ({sm: timeToM(r.start), em: timeToM(r.end)}));
            for(let h=oh; h<ch; h++) { [0,30].forEach(min => { const m = h*60+min; if(!booked.some(b => m >= b.sm && m < b.em)) addOpt(s, `${h}:${min===0?'00':'30'}`); }); }
            s.dataset.ch = ch; s.dataset.booked = JSON.stringify(booked);
            updateEndTimes(); document.getElementById('reservation-modal').classList.remove('hidden');
        }

        function updateEndTimes() {
            const s = document.getElementById('select-start-time'), e = document.getElementById('select-end-time'); 
            e.innerHTML = ""; if(!s.value) return;
            const [sh, sm] = s.value.split(':').map(Number);
            const smm = sh*60+sm, chm = parseInt(s.dataset.ch)*60, booked = JSON.parse(s.dataset.booked);
            let nextB = chm; booked.forEach(b => { if(b.sm > smm && b.sm < nextB) nextB = b.sm; });
            for(let m=smm+30; m<=nextB; m+=30) addOpt(e, `${Math.floor(m/60)}:${m%60===0?'00':'30'}`);
            if(e.options.length > 1) e.selectedIndex = 1;
        }

        function submitReservation() {
            const name = document.getElementById('input-name').value;
            if(!name) return alert("お名前を入力してください");
            const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.innerText = "送信中...";
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "reserve_class", name, date: selectedDateStr, startTime: document.getElementById('select-start-time').value, endTime: document.getElementById('select-end-time').value }) }).then(() => { alert("予約完了！"); location.reload(); });
        }

        function adminLogin(){ if(prompt("管理者パスワード")==="1234"){ isAdminMode=true; document.getElementById('admin-toolbar').classList.remove('hidden'); renderCalendar(); } }
        function openGlobalSettings() {
            document.getElementById('global-open-hour').value = APP_CONFIG.openHour;
            document.getElementById('global-close-hour').value = APP_CONFIG.closeHour;
            document.querySelectorAll('input[name="dow"]').forEach(cb => cb.checked = APP_CONFIG.closedDaysOfWeek.includes(parseInt(cb.value)));
            document.getElementById('global-setting-modal').classList.remove('hidden');
        }
        function saveGlobalSettings() {
            APP_CONFIG.openHour = parseInt(document.getElementById('global-open-hour').value);
            APP_CONFIG.closeHour = parseInt(document.getElementById('global-close-hour').value);
            const dows = []; document.querySelectorAll('input[name="dow"]:checked').forEach(cb => dows.push(parseInt(cb.value)));
            APP_CONFIG.closedDaysOfWeek = dows;
            saveChangesToGAS(false); closeModal('global-setting-modal');
        }
        function saveChangesToGAS(doReload){
            const payload = { action: "update_config", openHour: APP_CONFIG.openHour, closeHour: APP_CONFIG.closeHour, closedDays: APP_CONFIG.closedDaysOfWeek.join(','), exceptions: JSON.stringify(APP_CONFIG.exceptions) };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }).then(() => { if(doReload) { alert("全て保存完了！"); location.reload(); } else renderCalendar(); });
        }
        function openDateSettingModal(d, o, c){ selectedDateStr = d; document.getElementById('admin-date-title').innerText = d; document.getElementById('temp-open').value = o; document.getElementById('temp-close').value = c; document.getElementById('date-setting-modal').classList.remove('hidden'); }
        function applyDateSettings(){
            const s = document.querySelector('input[name="day-status"]:checked').value;
            if(s === 'default') delete APP_CONFIG.exceptions[selectedDateStr];
            else APP_CONFIG.exceptions[selectedDateStr] = { status: s, open: parseInt(document.getElementById('temp-open').value), close: parseInt(document.getElementById('temp-close').value) };
            closeModal('date-setting-modal'); renderCalendar();
        }
        function timeToM(t){ if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
        function addOpt(p,v){ const o=document.createElement('option'); o.value=v; o.innerText=v; p.appendChild(o); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function changeMonth(s){ currentDate.setMonth(currentDate.getMonth()+s); renderCalendar(); }
        function toggleTimeInputs(s){ document.getElementById('admin-time-inputs').classList.toggle('hidden', !s); }
    </script>
</body>
</html>
