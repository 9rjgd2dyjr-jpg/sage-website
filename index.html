<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Academy | Reservation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .calendar-cell { min-height: 100px; transition: 0.2s; }
        .calendar-cell:hover:not(.bg-red-50\/30) { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen">

    <div id="login-view" class="fixed inset-0 bg-indigo-900 flex items-center justify-center p-4 z-[100]">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm animate-fade-in text-center">
            <h2 class="text-2xl font-black mb-6 text-indigo-900 text-indigo-900">学習塾サージュ</h2>
            <div class="space-y-4">
                <input type="text" id="login-name" placeholder="お名前を入力" class="w-full p-4 border-2 border-slate-100 rounded-2xl font-bold text-center outline-indigo-500">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700">ログイン</button>
            </div>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden">お名前が見つかりません。シートに登録されているか確認してください。</p>
            <p class="text-slate-400 text-[10px] mt-6">※管理者は「admin」と入力</p>
        </div>
    </div>

    <div id="app-view" class="hidden animate-fade-in">
        <header class="bg-white border-b sticky top-0 z-50 p-4 shadow-sm">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-black text-indigo-900">サージュ予約管理</h1>
                <div class="flex items-center gap-3">
                    <span id="user-display" class="text-sm font-bold bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full border border-indigo-100"></span>
                    <button onclick="location.reload()" class="text-xs text-slate-400 hover:text-slate-600">ログアウト</button>
                </div>
            </div>
        </header>

        <div id="admin-toolbar" class="hidden bg-slate-800 text-white p-3 sticky top-[65px] z-40 shadow-lg">
            <div class="max-w-5xl mx-auto flex justify-between items-center text-xs md:text-sm">
                <span class="font-bold text-red-400"><i class="fa-solid fa-user-shield mr-1"></i>管理者モード</span>
                <div class="flex gap-2">
                    <button onclick="openGlobalSettings()" class="bg-slate-600 px-3 py-1.5 rounded">一括設定</button>
                    <button onclick="saveChangesToGAS(true)" class="bg-emerald-600 px-4 py-1.5 rounded font-bold">全て保存</button>
                </div>
            </div>
        </div>

        <main class="max-w-5xl mx-auto px-2 py-6">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
                <div class="flex items-center justify-between p-6 bg-indigo-50 border-b border-indigo-100">
                    <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="current-month-display" class="text-xl font-black text-indigo-900"></h2>
                    <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7"></div>
            </div>
        </main>
    </div>

    <div id="reservation-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
                <h3 class="font-black text-xl">授業予約</h3>
                <button onclick="closeModal('reservation-modal')"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <p id="modal-date-label" class="text-center font-bold text-slate-600 border-b pb-4"></p>
                <div class="grid grid-cols-2 gap-4">
                    <select id="select-start-time" onchange="updateEndTimes()" class="w-full border-2 p-4 rounded-2xl font-bold bg-white outline-indigo-500"></select>
                    <select id="select-end-time" class="w-full border-2 p-4 rounded-2xl font-bold bg-white outline-indigo-500"></select>
                </div>
                <button onclick="submitReservation()" id="submit-btn" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:scale-[1.02] transition-transform">予約を確定する</button>
            </div>
        </div>
    </div>

    <div id="global-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-8 space-y-6 shadow-2xl">
            <h3 class="text-xl font-black">一括設定</h3>
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="global-open-hour" class="border p-4 rounded-xl font-bold" placeholder="開始時間">
                <input type="number" id="global-close-hour" class="border p-4 rounded-xl font-bold" placeholder="終了時間">
            </div>
            <div class="flex flex-wrap gap-4 font-bold text-xs md:text-sm">
                <label><input type="checkbox" name="dow" value="1"> 月</label>
                <label><input type="checkbox" name="dow" value="2"> 火</label>
                <label><input type="checkbox" name="dow" value="3"> 水</label>
                <label><input type="checkbox" name="dow" value="4"> 木</label>
                <label><input type="checkbox" name="dow" value="5"> 金</label>
                <label class="text-blue-600"><input type="checkbox" name="dow" value="6"> 土</label>
                <label class="text-red-600"><input type="checkbox" name="dow" value="0"> 日</label>
            </div>
            <button onclick="saveGlobalSettings()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl">保存して反映</button>
        </div>
    </div>

    <div id="date-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 space-y-4">
            <h3 id="admin-date-title" class="font-black text-lg border-b pb-2">個別設定</h3>
            <div class="space-y-2 font-bold">
                <label class="block p-4 border rounded-2xl cursor-pointer"><input type="radio" name="day-status" value="default" checked onchange="toggleTimeInputs(false)"> 通常通り</label>
                <label class="block p-4 border rounded-2xl cursor-pointer text-red-500 bg-red-50"><input type="radio" name="day-status" value="closed" onchange="toggleTimeInputs(false)"> 休講</label>
                <label class="block p-4 border rounded-2xl cursor-pointer text-emerald-600 bg-emerald-50"><input type="radio" name="day-status" value="open" onchange="toggleTimeInputs(true)"> 開講(時間指定)</label>
            </div>
            <div id="admin-time-inputs" class="hidden flex gap-2"><input type="number" id="temp-open" class="border w-full p-3 rounded-xl">~<input type="number" id="temp-close" class="border w-full p-3 rounded-xl"></div>
            <button onclick="applyDateSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">決定</button>
        </div>
    </div>

    <footer class="py-10 text-center">
        <button onclick="adminLogin()" class="text-xs text-slate-300 hover:text-slate-500 transition"><i class="fa-solid fa-lock"></i></button>
    </footer>

    <script>
        // 反映済み：最新のURL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx_D8IqSm48xxFHQ_Q8FkmnRxo5ik4VwWFaDEr5vHL-pUa8EkFCaxm4ndjcMfQh9XZt/exec"; 
        
        let APP_CONFIG = { openHour: 10, closeHour: 22, closedDaysOfWeek: [0], exceptions: {}, reservations: [] };
        let currentUser = { name: "", isAdmin: false };
        let currentDate = new Date(), selectedDateStr = "";

        async function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            const btn = document.getElementById('login-btn');
            const error = document.getElementById('login-error');

            if (name === "admin") {
                const pass = prompt("管理者パスワード:");
                if (pass === "1234") {
                    currentUser = { name: "管理者", isAdmin: true };
                    return loginSuccess();
                } else {
                    alert("パスワードが違います");
                    return;
                }
            }

            btn.disabled = true; btn.innerText = "確認中...";
            try {
                const res = await fetch(`${GAS_URL}?action=login&name=${encodeURIComponent(name)}`);
                const data = await res.json();
                if (data.result === "success") {
                    currentUser = { name: name, isAdmin: false };
                    loginSuccess();
                } else { throw new Error(); }
            } catch (e) {
                error.classList.remove('hidden');
                btn.disabled = false; btn.innerText = "ログイン";
            }
        }

        async function loginSuccess() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${currentUser.name} さん`;
            if (currentUser.isAdmin) document.getElementById('admin-toolbar').classList.remove('hidden');
            
            const res = await fetch(GAS_URL);
            const data = await res.json();
            const cfg = data.config || {};
            APP_CONFIG.openHour = Number(cfg.openHour) || 10;
            APP_CONFIG.closeHour = Number(cfg.closeHour) || 22;
            if(cfg.closedDays) APP_CONFIG.closedDaysOfWeek = String(cfg.closedDays).split(',').map(Number);
            if(cfg.exceptions) APP_CONFIG.exceptions = JSON.parse(cfg.exceptions);
            APP_CONFIG.reservations = data.reservations || [];
            renderCalendar();
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = "";
            ['日','月','火','水','木','金','土'].forEach(d => grid.innerHTML += `<div class="py-3 text-center text-[10px] font-black text-slate-400 border-b">${d}</div>`);
            
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50/50 border-b border-r"></div>`;
            
            for(let d=1; d<=days; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dow = new Date(y, m, d).getDay();
                let status = "default", oh = APP_CONFIG.openHour, ch = APP_CONFIG.closeHour;
                
                if(APP_CONFIG.exceptions[dStr]) {
                    status = APP_CONFIG.exceptions[dStr].status;
                    if(status === 'open') { oh = APP_CONFIG.exceptions[dStr].open; ch = APP_CONFIG.exceptions[dStr].close; }
                } else { status = APP_CONFIG.closedDaysOfWeek.includes(dow) ? "closed" : "open"; }
                
                const closed = (status === "closed"), today = new Date().toDateString() === new Date(y, m, d).toDateString();
                const dayRes = APP_CONFIG.reservations.filter(r => r.date === dStr);
                const myRes = dayRes.find(r => r.studentName === currentUser.name);

                const cell = document.createElement('div');
                cell.className = `calendar-cell border-b border-r p-2 flex flex-col items-center justify-between cursor-pointer ${closed ? 'bg-red-50/30' : 'bg-white hover:bg-slate-50'}`;
                
                let badge = "";
                if (currentUser.isAdmin && dayRes.length > 0) {
                    badge = `<div class="text-[8px] bg-slate-800 text-white px-2 py-0.5 rounded-full mt-1">${dayRes.length}件の予約</div>`;
                } else if (myRes) {
                    badge = `<div class="text-[8px] bg-indigo-600 text-white px-2 py-0.5 rounded-full mt-1">予約済</div>`;
                }

                cell.innerHTML = `
                    <span class="text-xs font-black ${dow===0?'text-red-500':dow===6?'text-blue-500':'text-slate-600'} ${today?'bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center':''}">${d}</span>
                    <div class="flex flex-col items-center mb-1">
                        ${closed ? '<span class="text-[8px] text-red-400 font-bold border border-red-200 px-1 rounded">休校</span>' : `<span class="text-[9px] font-bold text-indigo-700">${oh}:00-${ch}:00</span>`}
                        ${badge}
                    </div>`;
                
                cell.onclick = () => isAdminMode ? openDateSettingModal(dStr, oh, ch) : (!closed && openReservationModal(dStr, oh, ch, dayRes));
                grid.appendChild(cell);
            }
        }

        function openReservationModal(dStr, oh, ch, dayRes) {
            selectedDateStr = dStr;
            document.getElementById('modal-date-label').innerText = `${dStr} （開講: ${oh}:00 - ${ch}:00）`;
            const s = document.getElementById('select-start-time'); s.innerHTML = "";
            const booked = dayRes.map(r => ({sm: timeToM(r.start), em: timeToM(r.end), name: r.studentName}));
            
            for(let h=oh; h<ch; h++) {
                [0,30].forEach(min => {
                    const m = h*60+min;
                    const b = booked.find(r => m >= r.sm && m < r.em);
                    if(!b) addOpt(s, `${h}:${min===0?'00':'30'}`);
                    else if(currentUser.isAdmin) addOpt(s, `${h}:${min===0?'00':'30'} (済:${b.name})`, true);
                });
            }
            s.dataset.ch = ch; s.dataset.booked = JSON.stringify(booked);
            updateEndTimes(); document.getElementById('reservation-modal').classList.remove('hidden');
        }

        function updateEndTimes() {
            const s = document.getElementById('select-start-time'), e = document.getElementById('select-end-time'); 
            e.innerHTML = ""; if(!s.value || s.options[s.selectedIndex].disabled) return;
            const [sh, sm] = s.value.split(':').map(Number);
            const smm = sh*60+sm, chm = parseInt(s.dataset.ch)*60, booked = JSON.parse(s.dataset.booked);
            let nextB = chm; booked.forEach(b => { if(b.sm > smm && b.sm < nextB) nextB = b.sm; });
            for(let m=smm+30; m<=nextB; m+=30) addOpt(e, `${Math.floor(m/60)}:${m%60===0?'00':'30'}`);
            if(e.options.length > 1) e.selectedIndex = 1;
        }

        function submitReservation() {
            const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.innerText = "送信中...";
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "reserve_class", name: currentUser.name, date: selectedDateStr, startTime: document.getElementById('select-start-time').value, endTime: document.getElementById('select-end-time').value }) })
            .then(() => { alert("予約完了！"); location.reload(); });
        }

        // --- ADMIN FUNCTIONS ---
        function adminLogin(){ if(prompt("管理者用パスワードを入力してください:")==="1234"){ isAdminMode=true; if(!isConfigLoaded) loginSuccess(); else { document.getElementById('admin-toolbar').classList.remove('hidden'); renderCalendar(); } } }
        function openGlobalSettings() {
            document.getElementById('global-open-hour').value = APP_CONFIG.openHour;
            document.getElementById('global-close-hour').value = APP_CONFIG.closeHour;
            document.querySelectorAll('input[name="dow"]').forEach(cb => cb.checked = APP_CONFIG.closedDaysOfWeek.includes(parseInt(cb.value)));
            document.getElementById('global-setting-modal').classList.remove('hidden');
        }
        function saveGlobalSettings() {
            APP_CONFIG.openHour = parseInt(document.getElementById('global-open-hour').value);
            APP_CONFIG.closeHour = parseInt(document.getElementById('global-close-hour').value);
            const dows = []; document.querySelectorAll('input[name="dow"]:checked').forEach(cb => dows.push(parseInt(cb.value)));
            APP_CONFIG.closedDaysOfWeek = dows;
            saveChangesToGAS(false); closeModal('global-setting-modal');
        }
        function saveChangesToGAS(doReload){
            const payload = { action: "update_config", openHour: APP_CONFIG.openHour, closeHour: APP_CONFIG.closeHour, closedDays: APP_CONFIG.closedDaysOfWeek.join(','), exceptions: JSON.stringify(APP_CONFIG.exceptions) };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }).then(() => { if(doReload) { alert("全て保存！"); location.reload(); } else renderCalendar(); });
        }
        function openDateSettingModal(d, o, c){ selectedDateStr = d; document.getElementById('admin-date-title').innerText = d; document.getElementById('temp-open').value = o; document.getElementById('temp-close').value = c; document.getElementById('date-setting-modal').classList.remove('hidden'); }
        function applyDateSettings(){
            const s = document.querySelector('input[name="day-status"]:checked').value;
            if(s === 'default') delete APP_CONFIG.exceptions[selectedDateStr];
            else APP_CONFIG.exceptions[selectedDateStr] = { status: s, open: parseInt(document.getElementById('temp-open').value), close: parseInt(document.getElementById('temp-close').value) };
            closeModal('date-setting-modal'); renderCalendar();
        }

        // --- UTILS ---
        function timeToM(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
        function addOpt(p,v,disabled=false){ const o=document.createElement('option'); o.value=v; o.innerText=v; o.disabled=disabled; p.appendChild(o); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function changeMonth(s){ currentDate.setMonth(currentDate.getMonth()+s); renderCalendar(); }
        function toggleTimeInputs(s){ document.getElementById('admin-time-inputs').classList.toggle('hidden', !s); }
    </script>
</body>
</html>
