<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Academy | Fast Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-cell { min-height: 90px; }
        /* 読み込み中のプレースホルダーアニメーション */
        .loading-shimmer { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen">

    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-black text-indigo-900 flex items-center">
                <i class="fa-solid fa-graduation-cap mr-2"></i> 学習塾サージュ
            </h1>
            <div id="sync-status" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-400">
                <i class="fa-solid fa-cloud mr-1"></i> 準備完了
            </div>
        </div>
    </header>

    <div id="admin-toolbar" class="hidden bg-slate-800 text-white p-2 sticky top-[53px] z-40 shadow-md animate-fade-in">
        <div class="max-w-5xl mx-auto flex justify-between items-center text-xs">
            <div class="font-bold"><span class="bg-red-500 px-1.5 py-0.5 rounded mr-1 text-[10px]">ADMIN</span>日付を編集可</div>
            <div class="flex space-x-1">
                <button onclick="openGlobalSettings()" class="bg-slate-600 px-2 py-1 rounded">一括</button>
                <button onclick="saveChangesToGAS(true)" class="bg-emerald-600 px-3 py-1 rounded font-bold">全て保存</button>
                <button onclick="location.reload()" class="bg-gray-600 px-2 py-1 rounded">終了</button>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-2 py-4 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <div class="flex items-center justify-between p-4 bg-indigo-50 border-b border-indigo-100">
                <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                <h2 id="current-month-display" class="text-lg font-black text-indigo-900"></h2>
                <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow hover:bg-indigo-600 hover:text-white transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 bg-white">
                <div class="py-2 text-center text-[10px] font-black text-red-500 bg-slate-50 border-b border-r">日</div>
                <div class="py-2 text-center text-[10px] font-black text-slate-400 bg-slate-50 border-b border-r">月</div>
                <div class="py-2 text-center text-[10px] font-black text-slate-400 bg-slate-50 border-b border-r">火</div>
                <div class="py-2 text-center text-[10px] font-black text-slate-400 bg-slate-50 border-b border-r">水</div>
                <div class="py-2 text-center text-[10px] font-black text-slate-400 bg-slate-50 border-b border-r">木</div>
                <div class="py-2 text-center text-[10px] font-black text-slate-400 bg-slate-50 border-b border-r">金</div>
                <div class="py-2 text-center text-[10px] font-black text-blue-500 bg-slate-50 border-b">土</div>
            </div>
        </div>
    </main>

    <div id="reservation-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl animate-fade-in">
            <div class="bg-indigo-600 p-5 text-white flex justify-between items-start">
                <div><h3 class="font-black text-xl">授業予約</h3><p id="modal-date-label" class="text-xs font-bold opacity-80 mt-1"></p></div>
                <button onclick="closeModal('reservation-modal')"><i class="fa-solid fa-circle-xmark text-2xl opacity-50 hover:opacity-100"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">生徒氏名</label><input type="text" id="input-name" placeholder="お名前" class="w-full border-2 border-slate-100 p-3 rounded-xl focus:border-indigo-500 outline-none transition font-bold"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">開始</label><select id="select-start-time" onchange="updateEndTimes()" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-white font-bold text-sm"></select></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">終了</label><select id="select-end-time" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-white font-bold text-sm"></select></div>
                </div>
                <button onclick="submitReservation()" id="submit-btn" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition">予約を確定する</button>
            </div>
        </div>
    </div>

    <div id="global-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 space-y-4">
            <h3 class="text-lg font-black">一括設定</h3>
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="global-open-hour" class="border p-3 rounded-xl font-bold" placeholder="開始(時)">
                <input type="number" id="global-close-hour" class="border p-3 rounded-xl font-bold" placeholder="終了(時)">
            </div>
            <div class="flex flex-wrap gap-2 text-xs font-bold">
                <label><input type="checkbox" name="dow" value="1"> 月</label>
                <label><input type="checkbox" name="dow" value="2"> 火</label>
                <label><input type="checkbox" name="dow" value="3"> 水</label>
                <label><input type="checkbox" name="dow" value="4"> 木</label>
                <label><input type="checkbox" name="dow" value="5"> 金</label>
                <label class="text-blue-600"><input type="checkbox" name="dow" value="6"> 土</label>
                <label class="text-red-600"><input type="checkbox" name="dow" value="0"> 日</label>
            </div>
            <button onclick="saveGlobalSettings()" class="w-full bg-emerald-600 text-white font-black py-3 rounded-xl">保存</button>
        </div>
    </div>

    <div id="date-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 space-y-4 font-bold text-sm">
            <h3 id="admin-date-title" class="font-black border-b pb-2">個別設定</h3>
            <label class="block p-3 border rounded-xl cursor-pointer"><input type="radio" name="day-status" value="default" checked onchange="toggleTimeInputs(false)"> 通常通り</label>
            <label class="block p-3 border rounded-xl cursor-pointer text-red-500"><input type="radio" name="day-status" value="closed" onchange="toggleTimeInputs(false)"> 休講</label>
            <label class="block p-3 border rounded-xl cursor-pointer text-emerald-500"><input type="radio" name="day-status" value="open" onchange="toggleTimeInputs(true)"> 開講(時間指定)</label>
            <div id="admin-time-inputs" class="hidden flex gap-2"><input type="number" id="temp-open" class="border w-full p-2">~<input type="number" id="temp-close" class="border w-full p-2"></div>
            <button onclick="applyDateSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-xl">反映</button>
        </div>
    </div>

    <footer class="py-8 text-center"><button onclick="adminLogin()" class="text-[10px] text-slate-300 hover:text-slate-500 transition"><i class="fa-solid fa-lock"></i></button></footer>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby74NtaPTr1XfqV3vQ_NhbyrO_uey4yxdOzT4rVoIO7KZdRM1x5Qd_MZxyyRQRNS93m/exec"; 
        let APP_CONFIG = { openHour: 10, closeHour: 22, closedDaysOfWeek: [0], exceptions: {}, reservations: [] };
        let currentDate = new Date(), selectedDateStr = "", isAdminMode = false, isConfigLoaded = false;

        // ページ読み込みと同時に「カレンダーのガワ」だけ即描画
        window.onload = () => {
            renderSkeletonCalendar(); // 読み込み中の見た目を作成
            loadDataAsync(); // 通信開始
        };

        function renderSkeletonCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calendar-grid');
            const dayHeaders = Array.from(grid.querySelectorAll('.bg-slate-50'));
            grid.innerHTML = "";
            dayHeaders.forEach(h => grid.appendChild(h));

            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50/30 border-b border-r border-slate-100"></div>`;
            for(let d=1; d<=days; d++) {
                grid.innerHTML += `<div class="calendar-cell border-b border-r border-slate-100 p-2 flex flex-col items-center">
                    <span class="text-xs font-black text-slate-300">${d}</span>
                    <div class="w-8 h-2 mt-4 rounded-full loading-shimmer"></div>
                    <div class="w-6 h-2 mt-1 rounded-full loading-shimmer"></div>
                </div>`;
            }
        }

        async function loadDataAsync() {
            const status = document.getElementById('sync-status');
            status.innerHTML = '<i class="fa-solid fa-sync fa-spin mr-1"></i> 通信中';
            status.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-indigo-100 text-indigo-600";

            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                const cfg = data.config || {};
                APP_CONFIG.openHour = Number(cfg.openHour) || 10;
                APP_CONFIG.closeHour = Number(cfg.closeHour) || 22;
                if(cfg.closedDays) APP_CONFIG.closedDaysOfWeek = String(cfg.closedDays).split(',').map(Number);
                if(cfg.exceptions) APP_CONFIG.exceptions = JSON.parse(cfg.exceptions);
                APP_CONFIG.reservations = data.reservations || [];
                isConfigLoaded = true;
                
                status.innerHTML = '<i class="fa-solid fa-check mr-1"></i> 最新の状態';
                status.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-emerald-100 text-emerald-600";
                
                renderCalendar(); // 本番描画
            } catch (e) {
                status.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-1"></i> 接続エラー';
                status.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-red-100 text-red-600";
                // 失敗してもスケルトンから数字だけは出せるようにする
                renderCalendar();
            }
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calendar-grid');
            const dayHeaders = Array.from(grid.querySelectorAll('.bg-slate-50'));
            grid.innerHTML = "";
            dayHeaders.forEach(h => grid.appendChild(h));

            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="calendar-cell bg-slate-50/50 border-b border-r border-slate-100"></div>`;
            
            for(let d=1; d<=days; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dow = new Date(y, m, d).getDay();
                let status = "default", oh = APP_CONFIG.openHour, ch = APP_CONFIG.closeHour;
                
                if(APP_CONFIG.exceptions[dStr]) {
                    status = APP_CONFIG.exceptions[dStr].status;
                    if(status === 'open') { oh = APP_CONFIG.exceptions[dStr].open; ch = APP_CONFIG.exceptions[dStr].close; }
                } else { status = APP_CONFIG.closedDaysOfWeek.includes(dow) ? "closed" : "open"; }
                
                const closed = (status === "closed"), today = new Date().toDateString() === new Date(y, m, d).toDateString();
                const cell = document.createElement('div');
                cell.className = `calendar-cell border-b border-r border-slate-100 p-2 cursor-pointer flex flex-col items-center justify-between ${closed ? 'bg-red-50/50' : 'bg-white'}`;
                
                const dateCircle = today ? 'bg-indigo-600 text-white rounded-full' : (dow===0?'text-red-500':dow===6?'text-blue-500':'text-slate-600');
                
                cell.innerHTML = `
                    <span class="text-xs font-black w-6 h-6 flex items-center justify-center ${dateCircle}">${d}</span>
                    <div class="flex flex-col items-center mb-1">
                        ${closed ? '<span class="text-[8px] font-black text-red-400 border border-red-100 px-1 rounded">休校</span>' : `<span class="text-[10px] font-black text-indigo-700">${oh}:00-${ch}:00</span><span class="text-[8px] font-black text-emerald-500">予約可</span>`}
                    </div>`;
                cell.onclick = () => isAdminMode ? openDateSettingModal(dStr, oh, ch) : (!closed && openReservationModal(dStr, oh, ch));
                grid.appendChild(cell);
            }
        }

        // 以下、一括保存などのロジック（そのまま）
        function openReservationModal(dStr, oh, ch) {
            selectedDateStr = dStr;
            document.getElementById('modal-date-label').innerText = `${dStr} （開講: ${oh}:00 - ${ch}:00）`;
            const s = document.getElementById('select-start-time'); s.innerHTML = "";
            const booked = APP_CONFIG.reservations.filter(r => r.date === dStr).map(r => ({sm: timeToM(r.start), em: timeToM(r.end)}));
            for(let h=oh; h<ch; h++) { [0,30].forEach(min => { const m = h*60+min; if(!booked.some(b => m >= b.sm && m < b.em)) addOpt(s, `${h}:${min===0?'00':'30'}`); }); }
            s.dataset.ch = ch; s.dataset.booked = JSON.stringify(booked);
            updateEndTimes(); document.getElementById('reservation-modal').classList.remove('hidden');
        }
        function updateEndTimes() {
            const s = document.getElementById('select-start-time'), e = document.getElementById('select-end-time'); 
            e.innerHTML = ""; if(!s.value) return;
            const [sh, sm] = s.value.split(':').map(Number);
            const smm = sh*60+sm, chm = parseInt(s.dataset.ch)*60, booked = JSON.parse(s.dataset.booked);
            let nextB = chm; booked.forEach(b => { if(b.sm > smm && b.sm < nextB) nextB = b.sm; });
            for(let m=smm+30; m<=nextB; m+=30) addOpt(e, `${Math.floor(m/60)}:${m%60===0?'00':'30'}`);
            if(e.options.length > 1) e.selectedIndex = 1;
        }
        function submitReservation() {
            const name = document.getElementById('input-name').value;
            if(!name) return alert("お名前をどうぞ！");
            const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.innerText = "送信中...";
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "reserve_class", name, date: selectedDateStr, startTime: document.getElementById('select-start-time').value, endTime: document.getElementById('select-end-time').value }) }).then(() => { alert("予約完了！"); location.reload(); });
        }
        function adminLogin(){ if(prompt("Pass")==="1234"){ isAdminMode=true; document.getElementById('admin-toolbar').classList.remove('hidden'); renderCalendar(); } }
        function openGlobalSettings() {
            document.getElementById('global-open-hour').value = APP_CONFIG.openHour;
            document.getElementById('global-close-hour').value = APP_CONFIG.closeHour;
            document.querySelectorAll('input[name="dow"]').forEach(cb => cb.checked = APP_CONFIG.closedDaysOfWeek.includes(parseInt(cb.value)));
            document.getElementById('global-setting-modal').classList.remove('hidden');
        }
        function saveGlobalSettings() {
            APP_CONFIG.openHour = parseInt(document.getElementById('global-open-hour').value);
            APP_CONFIG.closeHour = parseInt(document.getElementById('global-close-hour').value);
            const dows = []; document.querySelectorAll('input[name="dow"]:checked').forEach(cb => dows.push(parseInt(cb.value)));
            APP_CONFIG.closedDaysOfWeek = dows;
            saveChangesToGAS(false); closeModal('global-setting-modal');
        }
        function saveChangesToGAS(doReload){
            const payload = { action: "update_config", openHour: APP_CONFIG.openHour, closeHour: APP_CONFIG.closeHour, closedDays: APP_CONFIG.closedDaysOfWeek.join(','), exceptions: JSON.stringify(APP_CONFIG.exceptions) };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }).then(() => { if(doReload) { alert("保存しました"); location.reload(); } else renderCalendar(); });
        }
        function openDateSettingModal(d, o, c){ selectedDateStr = d; document.getElementById('admin-date-title').innerText = d; document.getElementById('temp-open').value = o; document.getElementById('temp-close').value = c; document.getElementById('date-setting-modal').classList.remove('hidden'); }
        function applyDateSettings(){
            const s = document.querySelector('input[name="day-status"]:checked').value;
            if(s === 'default') delete APP_CONFIG.exceptions[selectedDateStr];
            else APP_CONFIG.exceptions[selectedDateStr] = { status: s, open: parseInt(document.getElementById('temp-open').value), close: parseInt(document.getElementById('temp-close').value) };
            closeModal('date-setting-modal'); renderCalendar();
        }
        function timeToM(t){ if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
        function addOpt(p,v){ const o=document.createElement('option'); o.value=v; o.innerText=v; p.appendChild(o); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function changeMonth(s){ currentDate.setMonth(currentDate.getMonth()+s); renderCalendar(); }
        function toggleTimeInputs(s){ document.getElementById('admin-time-inputs').classList.toggle('hidden', !s); }
    </script>
</body>
</html>
