<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Academy | Class Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Admin Mode Toggle Highlight */
        .admin-mode-active .calendar-cell:hover { opacity: 0.8; transform: scale(0.98); }
        .admin-selected { border: 2px solid #ef4444 !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col relative">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-900 flex items-center cursor-pointer" onclick="showHome()">
                <i class="fa-solid fa-graduation-cap mr-2"></i> 学習塾サージュ
            </h1>
            <div>
                <button onclick="showHome()" class="text-gray-600 hover:text-indigo-600 font-bold mr-4 text-sm md:text-base">ホーム</button>
                <button onclick="startReservationFlow()" class="bg-indigo-600 text-white px-4 py-2 rounded-full font-bold hover:bg-indigo-700 transition shadow-md text-sm md:text-base flex items-center">
                    <i class="fa-regular fa-calendar-check mr-1"></i> 予約
                </button>
            </div>
        </div>
    </nav>

    <div id="admin-toolbar" class="hidden sticky top-[72px] z-40 bg-slate-800 text-white p-3 shadow-lg animate-fade-in">
        <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-2">
            <div class="flex items-center">
                <span class="bg-red-500 text-xs font-bold px-2 py-1 rounded mr-2">管理者モード</span>
                <span class="text-sm">カレンダーをクリックして休日を切り替えてください</span>
            </div>
            <div class="flex space-x-2">
                <button onclick="openAdminSettings()" class="bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded text-sm transition">
                    <i class="fa-solid fa-gear mr-1"></i> 一括設定
                </button>
                <button onclick="saveChangesToGAS()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-1.5 rounded text-sm font-bold shadow transition">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> 全て保存
                </button>
                <button onclick="logoutAdmin()" class="bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm transition">
                    終了
                </button>
            </div>
        </div>
    </div>

    <div id="home-view" class="block animate-fade-in">
        <header class="relative bg-gradient-to-r from-indigo-900 to-slate-800 text-white py-20 px-4 text-center overflow-hidden">
            <div class="relative z-10 max-w-4xl mx-auto">
                <h2 class="text-3xl md:text-5xl font-extrabold mb-4 tracking-tight">
                    未来を創る、確かな学びを。
                </h2>
                <p class="text-lg text-indigo-100 mb-8">
                    24時間いつでも、スマホから次回の授業予約が可能です。
                </p>
            </div>
        </header>

        <section class="max-w-4xl mx-auto -mt-10 px-4 relative z-20 pb-20">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-slate-100">
                <div class="grid grid-cols-1 gap-6">
                    <button id="home-reserve-btn" onclick="startReservationFlow()" class="group flex flex-col items-center justify-center p-8 bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-100 rounded-xl transition-all cursor-pointer">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-calendar-plus text-3xl text-emerald-600"></i>
                        </div>
                        <span class="text-xl font-bold text-emerald-900">授業を予約する</span>
                        <span class="text-sm text-emerald-600 mt-2 bg-white px-3 py-1 rounded-full shadow-sm">ここを押してカレンダーを読み込む</span>
                    </button>
                </div>
            </div>
        </section>
    </div>

    <div id="calendar-view" class="hidden flex-grow bg-slate-50 pb-20 animate-fade-in">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
                <button onclick="changeMonth(-1)" class="p-3 hover:bg-slate-100 rounded-full text-slate-500 transition">
                    <i class="fa-solid fa-chevron-left text-xl"></i>
                </button>
                <h2 id="current-month-display" class="text-2xl font-bold text-indigo-900"></h2>
                <button onclick="changeMonth(1)" class="p-3 hover:bg-slate-100 rounded-full text-slate-500 transition">
                    <i class="fa-solid fa-chevron-right text-xl"></i>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden select-none">
                <div class="grid grid-cols-7 bg-slate-100 border-b border-slate-200 text-sm">
                    <div class="py-3 text-center font-bold text-red-500">日</div>
                    <div class="py-3 text-center font-bold text-slate-600">月</div>
                    <div class="py-3 text-center font-bold text-slate-600">火</div>
                    <div class="py-3 text-center font-bold text-slate-600">水</div>
                    <div class="py-3 text-center font-bold text-slate-600">木</div>
                    <div class="py-3 text-center font-bold text-slate-600">金</div>
                    <div class="py-3 text-center font-bold text-blue-500">土</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 auto-rows-fr"></div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="showHome()" class="text-gray-500 hover:text-gray-800 underline text-sm">トップページに戻る</button>
            </div>
        </div>
    </div>

    <div id="reservation-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
            <div class="bg-indigo-600 p-5 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-xl"><i class="fa-solid fa-pen-nib mr-2"></i>授業予約</h3>
                    <p id="modal-date-display" class="text-indigo-100 text-sm mt-1"></p>
                </div>
                <button onclick="closeModal('reservation-modal')" class="text-white hover:bg-indigo-500 p-2 rounded-full transition">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">お名前</label>
                    <input type="text" id="input-name" placeholder="氏名を入力" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">開始</label>
                        <select id="select-start-time" onchange="updateEndTimes()" class="w-full border p-2.5 rounded-lg bg-white"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">終了</label>
                        <select id="select-end-time" class="w-full border p-2.5 rounded-lg bg-white"></select>
                    </div>
                </div>
                <button onclick="submitReservation()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg">予約確定</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-slate-900 bg-opacity-80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            <div class="bg-slate-800 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-xl"><i class="fa-solid fa-gear mr-2"></i>一括設定</h3>
                <button onclick="closeModal('admin-modal')" class="text-white hover:text-gray-300"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">開講時間 (時)</label>
                        <input type="number" id="admin-open-hour" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">閉講時間 (時)</label>
                        <input type="number" id="admin-close-hour" class="w-full border p-2 rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">定休日 (毎週)</label>
                    <div class="flex space-x-2">
                        <label><input type="checkbox" name="dow" value="1"> 月</label>
                        <label><input type="checkbox" name="dow" value="2"> 火</label>
                        <label><input type="checkbox" name="dow" value="3"> 水</label>
                        <label><input type="checkbox" name="dow" value="4"> 木</label>
                        <label><input type="checkbox" name="dow" value="5"> 金</label>
                        <label class="text-blue-600"><input type="checkbox" name="dow" value="6"> 土</label>
                        <label class="text-red-600"><input type="checkbox" name="dow" value="0"> 日</label>
                    </div>
                </div>
                <div class="text-xs text-gray-500">※ここでは「毎週のルール」を決めます。個別の休日はカレンダーをクリックして設定してください。</div>
                <button onclick="closeModal('admin-modal')" class="w-full bg-slate-600 text-white py-2 rounded">閉じる (保存はツールバーから)</button>
            </div>
        </div>
    </div>

    <footer class="bg-slate-900 text-slate-400 py-8 text-center mt-auto">
        <p class="text-sm opacity-70 mb-2">&copy; 2026 Sage Academy.</p>
        <button onclick="adminLogin()" class="text-xs text-white hover:text-gray-300 opacity-50 hover:opacity-100 transition">
            <i class="fa-solid fa-lock"></i> 管理者ログイン
        </button>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzWmMNZRygEqOC6eRCVzrzQYTDbC70KkHkDlzMQD1GE9ao_rGXyceqq9YUjf5XCLXsX/exec";

        // Global State
        let APP_CONFIG = { openHour: 10, closeHour: 22, closedDaysOfWeek: [0], holidays: [] };
        let currentDate = new Date();
        let selectedDateStr = "";
        let isConfigLoaded = false;
        let isAdminMode = false;

        // --- LAZY LOADING ---
        function startReservationFlow() {
            if (isConfigLoaded) {
                showCalendarView();
            } else {
                // Show loading on button
                const btns = document.querySelectorAll('button[onclick="startReservationFlow()"]');
                btns.forEach(btn => {
                    const originalHTML = btn.innerHTML;
                    btn.dataset.original = originalHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>読み込み中...';
                });

                fetchConfig().then(() => {
                    showCalendarView();
                }).catch(err => {
                    alert("通信エラーが発生しました");
                }).finally(() => {
                    btns.forEach(btn => {
                        if(btn.dataset.original) btn.innerHTML = btn.dataset.original;
                        btn.disabled = false;
                    });
                });
            }
        }

        function fetchConfig() {
            return fetch(GAS_URL)
                .then(response => response.json())
                .then(data => {
                    if(data.error) throw new Error(data.error);
                    APP_CONFIG.openHour = parseInt(data.openHour) || 10;
                    APP_CONFIG.closeHour = parseInt(data.closeHour) || 22;
                    if(data.closedDays) APP_CONFIG.closedDaysOfWeek = String(data.closedDays).split(',').map(Number);
                    if(data.holidays) APP_CONFIG.holidays = String(data.holidays).split(',').map(s => s.trim()).filter(s => s);
                    
                    isConfigLoaded = true;
                    console.log("Loaded:", APP_CONFIG);
                });
        }

        // --- ADMIN LOGIC ---
        function adminLogin() {
            const pass = prompt("管理者パスワード:");
            if (pass === "1234") {
                isAdminMode = true;
                // Ensure config is loaded even if accessed from footer directly
                if (!isConfigLoaded) {
                    alert("設定を読み込みます...");
                    fetchConfig().then(() => enableAdminMode());
                } else {
                    enableAdminMode();
                }
            } else if (pass !== null) {
                alert("パスワードが違います");
            }
        }

        function enableAdminMode() {
            document.body.classList.add('admin-mode-active');
            document.getElementById('admin-toolbar').classList.remove('hidden');
            showCalendarView();
            alert("管理者モード: カレンダーの日付をクリックして休日を切り替えられます");
        }

        function logoutAdmin() {
            isAdminMode = false;
            document.body.classList.remove('admin-mode-active');
            document.getElementById('admin-toolbar').classList.add('hidden');
            showHome();
        }

        function openAdminSettings() {
            document.getElementById('admin-open-hour').value = APP_CONFIG.openHour;
            document.getElementById('admin-close-hour').value = APP_CONFIG.closeHour;
            document.querySelectorAll('input[name="dow"]').forEach(cb => {
                cb.checked = APP_CONFIG.closedDaysOfWeek.includes(parseInt(cb.value));
            });
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        function toggleHoliday(dateStr) {
            // Check if it's already in holidays array
            const index = APP_CONFIG.holidays.indexOf(dateStr);
            if (index > -1) {
                // Remove (Make Open)
                APP_CONFIG.holidays.splice(index, 1);
            } else {
                // Add (Make Closed)
                APP_CONFIG.holidays.push(dateStr);
            }
            renderCalendar(); // Re-render to show changes
        }

        function saveChangesToGAS() {
            if (!confirm("現在のカレンダー設定（休日・営業時間）を保存しますか？")) return;

            // Gather data from Modal inputs (in case they changed)
            const newOpen = document.getElementById('admin-open-hour').value;
            const newClose = document.getElementById('admin-close-hour').value;
            const newDays = [];
            document.querySelectorAll('input[name="dow"]:checked').forEach(cb => newDays.push(cb.value));

            // Merge with the holidays array edited on calendar
            const payload = {
                action: "update_config",
                openHour: newOpen,
                closeHour: newClose,
                closedDays: newDays.join(','),
                holidays: APP_CONFIG.holidays.join(',') // Send array as comma string
            };

            fetch(GAS_URL, {
                method: "POST", mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("保存完了しました！");
                location.reload();
            }).catch(err => alert("保存エラー"));
        }

        // --- VIEW & CALENDAR ---
        function showHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('calendar-view').classList.add('hidden');
            window.scrollTo(0, 0);
        }
        function showCalendarView() {
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('calendar-view').classList.remove('hidden');
            renderCalendar();
            window.scrollTo(0, 0);
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${year}年 ${month + 1}月`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = "";
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty Cells
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = "min-h-[80px] border-b border-r border-slate-100 bg-slate-50";
                grid.appendChild(cell);
            }

            // Day Cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                const yyyy = dateObj.getFullYear();
                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                const dd = String(dateObj.getDate()).padStart(2, '0');
                const dateString = `${yyyy}-${mm}-${dd}`;

                // Determine Status
                const isWeeklyHoliday = APP_CONFIG.closedDaysOfWeek.includes(dayOfWeek);
                const isSpecialHoliday = APP_CONFIG.holidays.includes(dateString);
                
                // In Admin mode, we want to visualize what is what
                const isClosed = isWeeklyHoliday || isSpecialHoliday;
                const isToday = new Date().toDateString() === dateObj.toDateString();

                const cell = document.createElement('div');
                cell.className = "calendar-cell min-h-[80px] border-b border-r border-slate-100 p-2 relative transition cursor-pointer " + 
                                (isClosed ? "bg-red-50" : "hover:bg-indigo-50 bg-white");

                let textColor = "text-slate-700";
                if (dayOfWeek === 0) textColor = "text-red-500";
                if (dayOfWeek === 6) textColor = "text-blue-500";
                if (isClosed) textColor = "text-red-400 opacity-60";

                let statusBadge = "";
                if (isAdminMode) {
                    // Admin View Badges
                    if (isSpecialHoliday) statusBadge = '<span class="text-xs bg-red-200 text-red-800 px-1 rounded">臨時休</span>';
                    else if (isWeeklyHoliday) statusBadge = '<span class="text-xs text-gray-400">定休</span>';
                    else statusBadge = '<span class="text-xs text-gray-300">開講</span>';
                } else {
                    // User View Badges
                    statusBadge = isClosed 
                        ? '<span class="text-xs text-red-400 font-bold border border-red-200 px-1 rounded">休</span>' 
                        : '<span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">空き</span>';
                }

                cell.innerHTML = `
                    <span class="text-sm md:text-lg font-bold ${textColor} ${isToday ? 'bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center' : ''}">${day}</span>
                    <div class="mt-1 flex justify-center">${statusBadge}</div>
                `;

                // CLICK ACTION
                cell.onclick = () => {
                    if (isAdminMode) {
                        // Admin: Toggle Holiday
                        if (isWeeklyHoliday) {
                            alert("「毎週の定休日」として設定されています。\n変更するには「一括設定」から定休日を解除してください。");
                        } else {
                            toggleHoliday(dateString);
                        }
                    } else {
                        // User: Reserve
                        if (!isClosed) openReservationModal(dateString);
                    }
                };
                grid.appendChild(cell);
            }
        }

        function changeMonth(step) {
            currentDate.setMonth(currentDate.getMonth() + step);
            renderCalendar();
        }

        // --- RESERVATION LOGIC ---
        function openReservationModal(dateStr) {
            selectedDateStr = dateStr;
            const [y, m, d] = dateStr.split('-');
            document.getElementById('modal-date-display').innerText = `${m}月${d}日`;
            document.getElementById('reservation-modal').classList.remove('hidden');
            
            const startSelect = document.getElementById('select-start-time');
            startSelect.innerHTML = "";
            for (let h = APP_CONFIG.openHour; h < APP_CONFIG.closeHour; h++) {
                addOption(startSelect, `${h}:00`); addOption(startSelect, `${h}:30`);
            }
            updateEndTimes();
        }

        function addOption(s,v){const o=document.createElement('option');o.value=v;o.innerText=v;s.appendChild(o);}

        function updateEndTimes() {
            const sv = document.getElementById('select-start-time').value;
            const es = document.getElementById('select-end-time');
            es.innerHTML=""; if(!sv)return;
            const [sh, sm] = sv.split(':').map(Number);
            let cm = (sh*60)+sm+30; const clm = APP_CONFIG.closeHour*60;
            while(cm<=clm){
                const h=Math.floor(cm/60); const m=cm%60; const ts=`${h}:${m===0?'00':'30'}`;
                addOption(es,ts); if(cm===(sh*60)+sm+60) es.lastChild.selected=true; cm+=30;
            }
        }

        function submitReservation() {
            const name = document.getElementById('input-name').value;
            const start = document.getElementById('select-start-time').value;
            const end = document.getElementById('select-end-time').value;
            if(!name) { alert("名前を入力してください"); return; }
            if(!confirm("予約を確定しますか？")) return;

            // Loading state
            const btn = document.querySelector('#reservation-modal button');
            const originalText = btn.innerText;
            btn.innerText = "送信中..."; btn.disabled = true;

            const payload = { action: "reserve_class", name: name, date: selectedDateStr, startTime: start, endTime: end };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: {"Content-Type":"text/plain"}, body: JSON.stringify(payload)})
            .then(() => { alert("予約しました！"); closeModal('reservation-modal'); document.getElementById('input-name').value = ""; })
            .catch(err => alert("送信エラー"))
            .finally(() => { btn.innerText = originalText; btn.disabled = false; });
        }
    </script>
</body>
</html>
