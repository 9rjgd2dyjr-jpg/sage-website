<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Academy | Class Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-cell:hover { transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col relative">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-900 flex items-center cursor-pointer" onclick="showHome()">
                <i class="fa-solid fa-graduation-cap mr-2"></i> 学習塾サージュ
            </h1>
            <div>
                <button onclick="showHome()" class="text-gray-600 hover:text-indigo-600 font-bold mr-4 text-sm md:text-base">ホーム</button>
                <button onclick="startReservationFlow()" class="bg-indigo-600 text-white px-4 py-2 rounded-full font-bold hover:bg-indigo-700 transition shadow-md text-sm md:text-base">予約</button>
            </div>
        </div>
    </nav>

    <div id="admin-toolbar" class="hidden sticky top-[72px] z-40 bg-slate-800 text-white p-3 shadow-lg animate-fade-in">
        <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-2 text-xs md:text-sm">
            <div class="flex items-center"><span class="bg-red-500 font-bold px-2 py-1 rounded mr-2">管理者</span>日付をクリックで個別設定</div>
            <div class="flex space-x-2">
                <button onclick="openGlobalSettings()" class="bg-slate-600 px-3 py-1.5 rounded transition">一括設定</button>
                <button onclick="saveChangesToGAS(true)" class="bg-emerald-600 px-4 py-1.5 rounded font-bold transition">全て保存</button>
                <button onclick="logoutAdmin()" class="bg-gray-600 px-3 py-1.5 rounded transition">終了</button>
            </div>
        </div>
    </div>

    <div id="home-view" class="block animate-fade-in">
        <header class="bg-gradient-to-r from-indigo-900 to-slate-800 text-white py-20 px-4 text-center">
            <h2 class="text-3xl md:text-5xl font-extrabold mb-4">未来を創る、確かな学びを。</h2>
            <p class="text-lg text-indigo-100">スマホから24時間いつでも予約可能です。</p>
        </header>
        <section class="max-w-4xl mx-auto -mt-10 px-4">
            <button id="home-reserve-btn" onclick="startReservationFlow()" class="w-full bg-white rounded-2xl shadow-xl p-10 border-2 border-emerald-100 hover:bg-emerald-50 transition flex flex-col items-center">
                <i class="fa-solid fa-calendar-plus text-5xl text-emerald-600 mb-4"></i>
                <span class="text-2xl font-bold text-emerald-900">授業を予約する</span>
            </button>
        </section>
    </div>

    <div id="calendar-view" class="hidden flex-grow bg-slate-50 pb-20 animate-fade-in">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
                <button onclick="changeMonth(-1)" class="p-3 text-slate-500"><i class="fa-solid fa-chevron-left"></i></button>
                <h2 id="current-month-display" class="text-2xl font-bold text-indigo-900"></h2>
                <button onclick="changeMonth(1)" class="p-3 text-slate-500"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 bg-white rounded-xl shadow-lg border overflow-hidden"></div>
            <div class="mt-8 text-center"><button onclick="showHome()" class="text-gray-500 underline text-sm">戻る</button></div>
        </div>
    </div>

    <div id="reservation-modal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="bg-indigo-600 p-5 text-white flex justify-between">
                <div>
                    <h3 class="font-bold text-xl">授業予約</h3>
                    <p id="modal-hours-display" class="text-sm font-bold mt-1 opacity-90 text-white bg-indigo-500 px-2 py-0.5 rounded inline-block"></p>
                </div>
                <button onclick="closeModal('reservation-modal')"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="text" id="input-name" placeholder="お名前" class="w-full border p-3 rounded-lg outline-indigo-500">
                <div class="grid grid-cols-2 gap-4">
                    <select id="select-start-time" onchange="updateEndTimes()" class="border p-3 rounded-lg bg-white"></select>
                    <select id="select-end-time" class="border p-3 rounded-lg bg-white"></select>
                </div>
                <button onclick="submitReservation()" id="submit-btn" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 transition">予約を確定する</button>
            </div>
        </div>
    </div>

    <div id="date-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden p-6 space-y-4">
            <h3 id="admin-date-title" class="text-xl font-bold border-b pb-2">個別設定</h3>
            <div class="space-y-2">
                <label class="block p-3 border rounded cursor-pointer"><input type="radio" name="day-status" value="default" checked onchange="toggleTimeInputs(false)"> 通常通り</label>
                <label class="block p-3 border rounded cursor-pointer"><input type="radio" name="day-status" value="closed" onchange="toggleTimeInputs(false)"> 休講</label>
                <label class="block p-3 border rounded cursor-pointer"><input type="radio" name="day-status" value="open" onchange="toggleTimeInputs(true)"> 開講(時間指定)</label>
            </div>
            <div id="admin-time-inputs" class="hidden flex gap-2"><input type="number" id="temp-open" class="border w-full p-2" placeholder="10"><span>~</span><input type="number" id="temp-close" class="border w-full p-2" placeholder="22"></div>
            <button onclick="applyDateSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">決定（一時保存）</button>
        </div>
    </div>

    <div id="global-setting-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden p-6 space-y-6 shadow-2xl">
            <div class="flex justify-between items-center border-b pb-2">
                <h3 class="text-xl font-bold">一括設定 (デフォルト)</h3>
                <button onclick="closeModal('global-setting-modal')"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-bold text-gray-700 mb-1">基本 開講 (時)</label><input type="number" id="global-open-hour" class="w-full border p-2 rounded"></div>
                <div><label class="block text-sm font-bold text-gray-700 mb-1">基本 閉講 (時)</label><input type="number" id="global-close-hour" class="w-full border p-2 rounded"></div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">定休日 (毎週)</label>
                <div class="flex space-x-2 flex-wrap gap-y-2">
                    <label><input type="checkbox" name="dow" value="1"> 月</label>
                    <label><input type="checkbox" name="dow" value="2"> 火</label>
                    <label><input type="checkbox" name="dow" value="3"> 水</label>
                    <label><input type="checkbox" name="dow" value="4"> 木</label>
                    <label><input type="checkbox" name="dow" value="5"> 金</label>
                    <label class="text-blue-600"><input type="checkbox" name="dow" value="6"> 土</label>
                    <label class="text-red-600"><input type="checkbox" name="dow" value="0"> 日</label>
                </div>
            </div>
            <button onclick="saveGlobalSettings()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg">設定を保存して更新</button>
        </div>
    </div>

    <footer class="bg-slate-900 text-slate-600 py-6 text-center mt-auto">
        <button onclick="adminLogin()" class="text-xs hover:text-slate-400 opacity-30"><i class="fa-solid fa-lock"></i> 管理者用</button>
    </footer>

    <script>
        // 組み込み済み：最新URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycby74NtaPTr1XfqV3vQ_NhbyrO_uey4yxdOzT4rVoIO7KZdRM1x5Qd_MZxyyRQRNS93m/exec"; 
        
        let APP_CONFIG = { openHour: 10, closeHour: 22, closedDaysOfWeek: [0], exceptions: {}, reservations: [] };
        let currentDate = new Date(), selectedDateStr = "", isAdminMode = false, isConfigLoaded = false;

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error();
                    return await res.json();
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function startReservationFlow() {
            const btn = document.getElementById('home-reserve-btn');
            if (!isConfigLoaded) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-3xl mb-4"></i><span class="text-xl font-bold">読み込み中...</span>';
                try {
                    const data = await fetchWithRetry(GAS_URL);
                    const cfg = data.config || {};
                    APP_CONFIG.openHour = Number(cfg.openHour) || 10;
                    APP_CONFIG.closeHour = Number(cfg.closeHour) || 22;
                    if(cfg.closedDays) APP_CONFIG.closedDaysOfWeek = String(cfg.closedDays).split(',').map(Number);
                    if(cfg.exceptions) APP_CONFIG.exceptions = JSON.parse(cfg.exceptions);
                    APP_CONFIG.reservations = data.reservations || [];
                    isConfigLoaded = true;
                } catch (e) {
                    alert("通信エラー。");
                    location.reload();
                    return;
                }
            }
            showCalendarView();
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = "";
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            
            ['日','月','火','水','木','金','土'].forEach(d => {
                grid.innerHTML += `<div class="bg-slate-50 py-2 text-center text-xs font-bold text-slate-400 border-b">${d}</div>`;
            });
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="min-h-[80px] border-b border-r bg-slate-50"></div>`;
            for(let d=1; d<=days; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dow = new Date(y, m, d).getDay();
                let status = "default", oh = APP_CONFIG.openHour, ch = APP_CONFIG.closeHour;
                
                if(APP_CONFIG.exceptions[dStr]) {
                    status = APP_CONFIG.exceptions[dStr].status;
                    if(status === 'open') { oh = APP_CONFIG.exceptions[dStr].open; ch = APP_CONFIG.exceptions[dStr].close; }
                } else { 
                    status = APP_CONFIG.closedDaysOfWeek.includes(dow) ? "closed" : "open"; 
                }
                const closed = (status === "closed"), today = new Date().toDateString() === new Date(y, m, d).toDateString();
                const cell = document.createElement('div');
                cell.className = `min-h-[80px] border-b border-r p-2 cursor-pointer transition ${closed ? 'bg-red-50' : 'bg-white hover:bg-indigo-50'}`;
                cell.innerHTML = `
                    <span class="text-sm font-bold ${dow===0?'text-red-500':dow===6?'text-blue-500':'text-slate-600'} ${today?'bg-indigo-600 text-white rounded-full px-2 py-0.5':''}">${d}</span>
                    <div class="text-center mt-2">${closed ? '<span class="text-[10px] text-red-400 border border-red-200 px-1 rounded">休</span>' : '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 rounded-full">空</span>'}</div>`;
                cell.onclick = () => isAdminMode ? openDateSettingModal(dStr, oh, ch) : (!closed && openReservationModal(dStr, oh, ch));
                grid.appendChild(cell);
            }
        }

        function openReservationModal(dStr, oh, ch) {
            selectedDateStr = dStr;
            // 生徒側モーダルの時間表示をセット
            document.getElementById('modal-hours-display').innerText = `開講時間: ${oh}:00 - ${ch}:00`;
            const s = document.getElementById('select-start-time'); s.innerHTML = "";
            const booked = APP_CONFIG.reservations.filter(r => r.date === dStr).map(r => ({sm: timeToM(r.start), em: timeToM(r.end)}));
            for(let h=oh; h<ch; h++) {
                [0,30].forEach(min => {
                    const m = h*60+min;
                    if(!booked.some(b => m >= b.sm && m < b.em)) addOpt(s, `${h}:${min===0?'00':'30'}`);
                });
            }
            s.dataset.ch = ch; s.dataset.booked = JSON.stringify(booked);
            updateEndTimes(); 
            document.getElementById('reservation-modal').classList.remove('hidden');
        }

        function updateEndTimes() {
            const s = document.getElementById('select-start-time'), e = document.getElementById('select-end-time'); 
            e.innerHTML = ""; if(!s.value) return;
            const [sh, sm] = s.value.split(':').map(Number);
            const smm = sh*60+sm, chm = parseInt(s.dataset.ch)*60, booked = JSON.parse(s.dataset.booked);
            let nextB = chm;
            booked.forEach(b => { if(b.sm > smm && b.sm < nextB) nextB = b.sm; });
            for(let m=smm+30; m<=nextB; m+=30) addOpt(e, `${Math.floor(m/60)}:${m%60===0?'00':'30'}`);
        }

        function submitReservation() {
            const name = document.getElementById('input-name').value;
            if(!name) return alert("名前を入力してください");
            const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.innerText = "送信中...";
            const payload = { action: "reserve_class", name, date: selectedDateStr, startTime: document.getElementById('select-start-time').value, endTime: document.getElementById('select-end-time').value };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }).then(() => { alert("予約完了！"); location.reload(); });
        }

        function adminLogin(){ if(prompt("パスワード")==="1234"){ isAdminMode=true; startReservationFlow(); document.getElementById('admin-toolbar').classList.remove('hidden'); } }
        
        function openGlobalSettings() {
            document.getElementById('global-open-hour').value = APP_CONFIG.openHour;
            document.getElementById('global-close-hour').value = APP_CONFIG.closeHour;
            document.querySelectorAll('input[name="dow"]').forEach(cb => {
                cb.checked = APP_CONFIG.closedDaysOfWeek.includes(parseInt(cb.value));
            });
            document.getElementById('global-setting-modal').classList.remove('hidden');
        }

        function saveGlobalSettings() {
            APP_CONFIG.openHour = parseInt(document.getElementById('global-open-hour').value);
            APP_CONFIG.closeHour = parseInt(document.getElementById('global-close-hour').value);
            const dows = [];
            document.querySelectorAll('input[name="dow"]:checked').forEach(cb => dows.push(parseInt(cb.value)));
            APP_CONFIG.closedDaysOfWeek = dows;
            // リロードせず、その場でカレンダーを更新するように修正
            saveChangesToGAS(false); 
            closeModal('global-setting-modal');
        }

        function saveChangesToGAS(doReload){
            const payload = { action: "update_config", openHour: APP_CONFIG.openHour, closeHour: APP_CONFIG.closeHour, closedDays: APP_CONFIG.closedDaysOfWeek.join(','), exceptions: JSON.stringify(APP_CONFIG.exceptions) };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }).then(() => { 
                if(doReload) {
                    alert("保存完了！"); 
                    location.reload(); 
                } else {
                    renderCalendar(); // リロードせず描画だけ更新
                }
            });
        }

        function openDateSettingModal(d, o, c){ selectedDateStr = d; document.getElementById('admin-date-title').innerText = d; document.getElementById('temp-open').value = o; document.getElementById('temp-close').value = c; document.getElementById('date-setting-modal').classList.remove('hidden'); }
        
        function applyDateSettings(){
            const s = document.querySelector('input[name="day-status"]:checked').value;
            if(s === 'default') delete APP_CONFIG.exceptions[selectedDateStr];
            else APP_CONFIG.exceptions[selectedDateStr] = { status: s, open: parseInt(document.getElementById('temp-open').value), close: parseInt(document.getElementById('temp-close').value) };
            closeModal('date-setting-modal'); 
            renderCalendar();
        }

        function timeToM(t){ if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
        function addOpt(p,v){ const o=document.createElement('option'); o.value=v; o.innerText=v; p.appendChild(o); }
        function showHome(){ document.getElementById('home-view').classList.remove('hidden'); document.getElementById('calendar-view').classList.add('hidden'); }
        function showCalendarView(){ document.getElementById('home-view').classList.add('hidden'); document.getElementById('calendar-view').classList.remove('hidden'); renderCalendar(); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function changeMonth(s){ currentDate.setMonth(currentDate.getMonth()+s); renderCalendar(); }
        function toggleTimeInputs(s){ document.getElementById('admin-time-inputs').classList.toggle('hidden', !s); }
        function logoutAdmin(){ location.reload(); }
    </script>
</body>
</html>
